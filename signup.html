<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Registrarte a Keevli</title>
<link href="https://fonts.googleapis.com/css2?family=Carter+One&display=swap" rel="stylesheet">
<style>
    @import url('https://fonts.googleapis.com/css2?family=Carter+One&display=swap');

    body {
        font-family: 'Carter One', cursive;
        background-size: cover;
        color: white;
        margin: 0;
        padding: 0;
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative;
    }

    .fullscreen-gif {
        position: fixed;
        top: 0; left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        z-index: -2;
    }

    .gif-overlay {
        position: fixed;
        top: 0; left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.4);
        z-index: -1;
    }

    .container {
        position: relative;
        text-align: center;
        z-index: 1;
        width: 90%;
        max-width: 320px;
    }

    .input-wrapper {
        position: relative;
        display: block;
        margin: 10px 0;
        width: 100%;
    }

    input {
        width: 100%;
        padding: 10px 40px 10px 10px;
        font-size: 16px;
        border-radius: 8px;
        border: none;
        box-sizing: border-box;
    }

    .eye-icon {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        cursor: pointer;
        width: 20px;
        height: 20px;
    }

    button {
        font-family: 'Carter One', cursive;
        border: none;
        cursor: pointer;
        border-radius: 16px;
        transition: all 0.25s ease-in-out;
    }

    #signupBtn {
        padding: 10px 32px;
        font-size: 18px;
        background-color: rgb(255, 240, 60);
        color: rgb(255, 255, 255);
        box-shadow: 0 5px 0 rgb(200, 140, 0);
        margin-top: 10px;
    }

    #signupBtn:hover {
        transform: scale(1.05);
        background-color: rgb(255, 255, 120);
        box-shadow: 0 3px 0 rgb(200, 140, 0);
    }

    #signupBtn:active {
        transform: translateY(3px) scale(0.98);
        box-shadow: 0 2px 0 rgb(150, 100, 0);
    }

    #back-button {
        position: fixed;
        top: 20px;
        left: 20px;
        padding: 9px 28px;
        font-size: 17px;
        background-color: rgb(90, 180, 255);
        color: white;
        box-shadow: 0 5px 0 rgb(30, 100, 200);
        border-radius: 16px;
        cursor: pointer;
        z-index: 10;
    }

    #back-button:hover {
        transform: scale(1.05);
        background-color: rgb(120, 200, 255);
        box-shadow: 0 3px 0 rgb(30, 100, 200);
    }

    #back-button:active {
        transform: translateY(3px) scale(0.98);
        box-shadow: 0 2px 0 rgb(20, 70, 150);
    }

    .error {
        color: rgb(255, 0, 0);
        margin-top: 10px;
        font-size: 14px;
    }
</style>
</head>
<body>
<button id="back-button" onclick="goBack()">&#9664; Atrás</button>
<img src="Header.png" alt="Animated GIF" class="fullscreen-gif">
<div class="gif-overlay"></div>

<script>
const backButton = document.getElementById('back-button');
if (window.history.length <= 1) {
    backButton.style.display = 'none';
}
function goBack() {
    window.history.back();
}
</script>

<div class="container">
<h1>Crear una Cuenta</h1>

<input type="text" id="username" placeholder="Nombre de Usuario" required>

<div class="input-wrapper">
    <input type="password" id="password" placeholder="Contraseña" required>
    <img src="EyeClosed.png" id="togglePassword" class="eye-icon">
</div>

<div class="input-wrapper">
    <input type="password" id="confirmPassword" placeholder="Confirmar Contraseña" required>
    <img src="EyeClosed.png" id="toggleConfirmPassword" class="eye-icon">
</div>

<button id="signupBtn">Crear Cuenta</button>

<p style="font-size: 14px; margin-top: 10px;">
    Al registrarte aceptas los 
    <a href="terms.html" style="color: rgb(58, 58, 255); text-decoration: underline;">
        Términos y Condiciones
    </a>.
</p>

<p class="error" id="errorMsg"></p>
<p class="error" id="passwordError"></p>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyADhesCk4kYXN73EyYaOuYgB1dQxzIQLkk",
    authDomain: "keevli.firebaseapp.com",
    projectId: "keevli",
    storageBucket: "keevli.firebasestorage.app",
    messagingSenderId: "1057187563274",
    appId: "1:1057187563274:web:df61aed04b3a2c63a19cf3",
    measurementId: "G-4E8SQT6TL1"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const usernameInput = document.getElementById("username");
const passwordInput = document.getElementById("password");
const confirmPasswordInput = document.getElementById("confirmPassword");
const errorMsg = document.getElementById("errorMsg");
const passwordError = document.getElementById("passwordError");

const togglePassword = document.getElementById("togglePassword");
const toggleConfirmPassword = document.getElementById("toggleConfirmPassword");

// Toggle password visibility with eye images
function toggleEye(inputField, toggleImg) {
    if (inputField.type === "password") {
        inputField.type = "text";
        toggleImg.src = "EyeOpen.png";
    } else {
        inputField.type = "password";
        toggleImg.src = "EyeClosed.png";
    }
}

togglePassword.addEventListener("click", () => toggleEye(passwordInput, togglePassword));
toggleConfirmPassword.addEventListener("click", () => toggleEye(confirmPasswordInput, toggleConfirmPassword));

// Signup logic
document.getElementById("signupBtn").addEventListener("click", async () => {
    errorMsg.textContent = "";
    passwordError.textContent = "";

    const username = usernameInput.value.trim();
    const password = passwordInput.value;
    const confirmPassword = confirmPasswordInput.value;
    const email = `${username}@keevliapp.com`;

    const onlyLettersRegex = /^[A-Za-zÁÉÍÓÚáéíóúÑñ]+$/;

    if (username.length === 0) { errorMsg.textContent = "Por favor, ingresa un nombre de usuario."; return; }
    if (!onlyLettersRegex.test(username)) { errorMsg.textContent = "El nombre de usuario solo puede contener letras."; return; }
    if (username.length > 12) { errorMsg.textContent = "El nombre de usuario no puede tener más de 12 caracteres."; return; }
    if (username.length < 3) { errorMsg.textContent = "El nombre de usuario debe tener al menos 3 letras."; return; }

    if (password !== confirmPassword) { passwordError.textContent = "Las contraseñas no coinciden."; return; }

    try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;

        await setDoc(doc(db, "users", user.uid), {
            uid: user.uid,
            username: username,
            email: user.email,
            totalCoins: 0,
            totalPoints: 0,
            profileImage: "PPB0",
            unlocked: ["PPB0", "PPG0"],
            ownedCharacters: ["Char1", "CharWom1"],
            selectedCharacter: "Char1"
        });

        new Audio('SelectGameSound.mp3').play();
        setTimeout(() => { window.location.href = "index.html"; }, 800);

    } catch (error) {
        errorMsg.textContent = "Error al crear la cuenta: " + error.message;
    }
});
</script>

</body>
</html>